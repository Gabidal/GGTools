#!/usr/bin/make -f

export DH_VERBOSE ?= 1
export DEB_BUILD_MAINT_OPTIONS = hardening=+all

include /usr/share/dpkg/default.mk

BUILD_DIR := $(CURDIR)/bin/obj-$(DEB_HOST_GNU_TYPE)
EXPORT_DIR := $(CURDIR)/bin/export
DESTDIR := $(CURDIR)/debian/tmp

%:
	dh $@

override_dh_auto_configure:
	meson setup $(BUILD_DIR) $(CURDIR)/bin \
		--prefix=/usr \
		--libdir=/usr/lib/$(DEB_HOST_MULTIARCH) \
		--includedir=/usr/include \
		--buildtype=release

override_dh_auto_build:
	meson compile -C $(BUILD_DIR)

override_dh_auto_install:
	# Ensure the optional developer header is generated alongside the default export
	meson compile -C $(BUILD_DIR) generate_dev_header
	install -d $(DESTDIR)/usr/include/ggui
	for header in GGUI.h GGUIDev.h; do \
		if [ -f $(EXPORT_DIR)/$$header ]; then \
			lower_name=$$(printf '%s\n' "$$header" | tr '[:upper:]' '[:lower:]'); \
			install -m 0644 $(EXPORT_DIR)/$$header $(DESTDIR)/usr/include/ggui/$$lower_name; \
		fi; \
	done
	install -d $(DESTDIR)/usr/lib/$(DEB_HOST_MULTIARCH)
	test -f $(EXPORT_DIR)/libGGUIUnix.a
	install -m 0644 $(EXPORT_DIR)/libGGUIUnix.a $(DESTDIR)/usr/lib/$(DEB_HOST_MULTIARCH)/libggui.a
	install -d $(DESTDIR)/usr/lib/$(DEB_HOST_MULTIARCH)/pkgconfig
	cat <<'EOF' > $(DESTDIR)/usr/lib/$(DEB_HOST_MULTIARCH)/pkgconfig/libggui.pc
prefix=/usr
exec_prefix=${prefix}
libdir=${exec_prefix}/lib/$(DEB_HOST_MULTIARCH)
includedir=${prefix}/include/ggui

Name: GGUI
Description: Terminal UI library
Version: $(DEB_VERSION_UPSTREAM)
Libs: -L${libdir} -lggui
Cflags: -I${includedir}
EOF

override_dh_auto_clean:
	if [ -d $(BUILD_DIR) ]; then \
		meson --internal clean -C $(BUILD_DIR) || true; \
		rm -rf $(BUILD_DIR); \
	fi
	for artifact in GGUI.h GGUIDev.h libGGUIUnix.a; do \
		if [ -f $(EXPORT_DIR)/$$artifact ]; then rm -f $(EXPORT_DIR)/$$artifact; fi; \
	done
	if [ -d $(EXPORT_DIR) ]; then rm -rf $(EXPORT_DIR); fi
