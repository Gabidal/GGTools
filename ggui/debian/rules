#!/usr/bin/make -f

export DH_VERBOSE ?= 1
export DEB_BUILD_MAINT_OPTIONS = hardening=+all

include /usr/share/dpkg/default.mk

MODULES_DIR := $(CURDIR)/../modules/ggui
BIN_DIR := $(MODULES_DIR)/bin
EXPORT_DIR := $(BIN_DIR)/export
DESTDIR := $(CURDIR)/debian/tmp
GGUI_VERSION := $(shell sed -n "s/.*version[[:space:]]*:[[:space:]]*'\(.*\)'.*/\1/p" $(BIN_DIR)/meson.build | head -n1)

%:
	dh $@

override_dh_auto_configure:
	cd $(BIN_DIR) && ./init.sh

override_dh_auto_build:
	cd $(BIN_DIR) && ./export.sh

override_dh_auto_install:
	install -d $(DESTDIR)/usr/include/ggui
	install -m644 $(EXPORT_DIR)/ggui.h $(DESTDIR)/usr/include/ggui/
	install -m644 $(EXPORT_DIR)/ggui_dev.h $(DESTDIR)/usr/include/ggui/
	install -d $(DESTDIR)/usr/lib/$(DEB_HOST_MULTIARCH)
	install -m644 $(EXPORT_DIR)/libggui.a $(DESTDIR)/usr/lib/$(DEB_HOST_MULTIARCH)/
	install -d $(DESTDIR)/usr/lib/$(DEB_HOST_MULTIARCH)/pkgconfig
	printf 'prefix=/usr\nexec_prefix=$${prefix}\nlibdir=$${exec_prefix}/lib/$(DEB_HOST_MULTIARCH)\nincludedir=$${prefix}/include/ggui\n\nName: GGUI\nDescription: GGUI terminal UI toolkit\nVersion: %s\nLibs: -L$${libdir} -lggui\nCflags: -I$${includedir}\n' "$(if $(GGUI_VERSION),$(GGUI_VERSION),0.0.0)" > $(DESTDIR)/usr/lib/$(DEB_HOST_MULTIARCH)/pkgconfig/libggui.pc

override_dh_auto_clean:
	rm -rf $(BIN_DIR)/build $(BIN_DIR)/build-release $(BIN_DIR)/build-win $(BIN_DIR)/build-linux
	rm -f $(EXPORT_DIR)/libggui.a $(EXPORT_DIR)/ggui.h $(EXPORT_DIR)/ggui_dev.h
